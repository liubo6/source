---
title: 长连接和短连接
date: 2016-07-20 18:28:45
categories: 协议
tags: TCP
---
# TCP连接
当网络通信时采用TCP协议时，在真正的读写操作之前，server与client之间必须建立一个连接，当读写操作完成后，双方不再需要这个连接时它们可以释放这个连接，连接的建立是需要三次握手的，而释放则需要4次握手，所以说每个连接的建立都是需要资源消耗和时间消耗的
<!--more-->
## 三次握手
![](http://ww2.sinaimg.cn/mw690/69045600gw1f605vk1f9ej20i80cidh1.jpg)
## 四次挥手
![](http://ww4.sinaimg.cn/mw690/69045600gw1f605vsz06sj20fd09v74m.jpg) 

# TCP短连接
client向server发起连接请求，server接到请求，然后双方建立连接。client向server发送消息，server回应client，然后一次读写就完成了，这时候双方任何一个都可以发起close操作，不过一般都是client先发起close操作
短连接一般只会在client/server间传递一次读写操作
短连接的优点是：管理起来比较简单，存在的连接都是有用的连接，不需要额外的控制手段
## 短连接的操作步骤
建立连接——数据传输——关闭连接...建立连接——数据传输——关闭连接


# TCP长连接
client向server发起连接，server接受client连接，双方建立连接。Client与server完成一次读写之后，它们之间的连接并不会主动关闭，后续的读写操作会继续使用这个连接

## 长连接的操作步骤
建立连接——数据传输...（保持连接）...数据传输——关闭连接

首先说一下TCP/IP详解上讲到的TCP保活(keep-alive)功能，保活功能主要为服务器应用提供，服务器应用希望知道客户主机是否崩溃，从而可以代表客户使用资源。如果客户已经消失，使得服务器上保留一个半开放的连接，而服务器又在等待来自客户端的数据，则服务器将应远等待客户端的数据，保活功能就是试图在服务 器端检测到这种半开放的连接。
如果一个给定的连接在两小时内没有任何的动作，则服务器就向客户发一个探测报文段，客户主机必须处于以下4个状态之一
1. 客户主机依然正常运行，并从服务器可达。客户的TCP响应正常，而服务器也知道对方是正常的，服务器在两小时后将保活定时器复位。
1. 客户主机已经崩溃，并且关闭或者正在重新启动。在任何一种情况下，客户的TCP都没有响应。服务端将不能收到对探测的响应，并在75秒后超时。服务器总共发送10个这样的探测 ，每个间隔75秒。如果服务器没有收到一个响应，它就认为客户主机已经关闭并终止连接。
1. 客户主机崩溃并已经重新启动。服务器将收到一个对其保活探测的响应，这个响应是一个复位，使得服务器终止这个连接。
1. 客户机正常运行，但是服务器不可达，这种情况与2类似，TCP能发现的就是没有收到探查的响应。


在长连接的应用场景下，client端一般不会主动关闭它们之间的连接，Client与server之间的连接如果一直不关闭的话，会存在一个问题，随着客户端连接越来越多，server早晚有扛不住的时候，这时候server端需要采取一些策略，如关闭一些长时间没有读写事件发生的连接，这样可以避免一些恶意连接导致server端服务受损；如果条件再允许就可以以客户端机器为颗粒度，限制每个客户端的最大长连接数，这样可以完全避免某个恶意客户端连累后端服务.
长连接和短连接的产生在于client和server采取的关闭策略


# HTTP-TCP
HTTP协议的长连接和短连接，实质上是TCP协议的长连接和短连接
###  在HTTP/1.0中，默认使用的是短连接
浏览器和服务器每进行一次HTTP操作，就建立一次连接，但任务结束就中断连接。如果客户端浏览器访问的某个HTML或其他类型的 Web页中包含有其他的Web资源，如JavaScript文件、图像文件、CSS文件等；当浏览器每遇到这样一个Web资源，就会建立一个HTTP会话。
###  HTTP/1.1起，默认使用长连接
用以保持连接特性。使用长连接的HTTP协议，会在响应头有加入这行代码```Connection:keep-alive ```
在使用长连接的情况下，当一个网页打开完成后，客户端和服务器之间用于传输HTTP数据的 TCP连接不会关闭，如果客户端再次访问这个服务器上的网页，会继续使用这一条已经建立的连接。Keep-Alive不会永久保持连接，它有一个保持时间，可以在不同的服务器软件（如Apache）中设定这个时间。实现长连接要客户端和服务端都支持长连接

# 优缺点
长连接可以省去较多的TCP建立和关闭的操作，减少浪费，节约时间,对于频繁请求资源的客户来说，较适用长连接,存在一个问题，存活功能的探测周期太长，还有就是它只是探测TCP连接的存活，，遇到恶意的连接时，随着客户端连接越来越多，server早晚有扛不住的时候

短连接对于服务器来说管理较为简单，存在的连接都是有用的连接，不需要额外的控制手段。但如果客户请求频繁，将在TCP的建立和关闭操作上浪费时间和带宽

# 使用场景
长连接多用于操作频繁，点对点的通讯，而且连接数不能太多情况,每个TCP连接都需要三步握手，这需要时间，如果每个操作都是先连接，再操作的话那么处理速度会降低很多，所以每个操作完后都不断开,例如：数据库的连接用长连接

WEB网站的http服务一般都用短链接，因为长连接对于服务端来说会耗费一定的资源，而像WEB网站这么频繁的成千上万甚至上亿客户端的连接用短连接会更省一些资源,并发大,每个用户无需频繁操作情况下需用短连

比如网游,是否需要服务器主动给客户端推送消息，只有长连接才能实现这个功能
手游一般是使用短连接的方式来设计游戏
tcp需要保持连接状态，这个在pc上可能不是问题，在手机上问题就大了。手机信号不稳定，ios操作系统会将后台非特殊进程挂起，导致游戏断线需要断线重连，也就是重新登陆一次，做过网游的同学都知道，**游戏登陆操作对服务器的开销往往是最大**的
http+udp，这种相对保守一些，逻辑相关的使用http协议，保证游戏逻辑不会出通讯上的问题，推送类的使用udp，比如聊天，世界公告等等，这些就算你的udp协议写的烂，也不会产生严重问题。如果实时性要求非常高的战斗功能，请使用udp

基本上都是用的TCP长连接，只有一些休闲游戏或者弱交互(和服务器)的卡牌游戏用的http短连接

