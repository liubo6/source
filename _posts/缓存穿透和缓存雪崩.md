---
title: 缓存穿透和缓存雪崩
date: 2016-06-20 10:01:58
categories: 缓存
tags: 缓存
---
我们在用缓存的时候，不管是Redis或者Memcached，基本上会通用遇到以下三个问题
1. 缓存穿透
1. 缓存并发
1. 缓存失效

<!--more-->

## 通常缓存使用业务逻辑
![](http://ww2.sinaimg.cn/mw690/69045600gw1f51gz9tm00j20c90c43yk.jpg)

## 通常缓存更新业务逻辑
![](http://ww3.sinaimg.cn/mw690/69045600gw1f51hewbdhlj209c0f3mx7.jpg)


##  缓存穿透
### 什么是缓存穿透
缓存系统，都是按照key去缓存查询，如果不存在对应的value，就应该去后端数据库系统查找。如果key对应的value是一定不存在的，并且对该key并发请求量很大，就会对后端系统造成很大的压力。这就叫做缓存穿透

###  如何避免缓存穿透
1. 对查询结果为空的情况也进行缓存，缓存时间设置短一点，或者该key对应的数据insert了之后清理缓存
如果在数据库中不存在的话，就在缓存中做一个空标志，（比如new 一个新对象，但是这个对象的字段都是空的。）以后对这些数据的访问，直接就能在缓存中查到，就不需再查数据库了，通过查询缓存发现得到的为空的标志，就直接返回。

1. 布隆过滤器，将所有可能存在的数据哈希到一个足够大的bitmap中，一个一定不存在的数据会被 这个bitmap拦截掉，


##  缓存并发
如果网站并发访问高，一个缓存如果失效，可能出现多个进程同时查询DB，同时设置缓存的情况，如果并发确实很大，这也可能造成DB压力过大，还有缓存频繁更新的问题

对缓存查询加锁，如果KEY不存在，就加锁，然后查DB入缓存，然后解锁；其他进程如果发现有锁就等待，然后等解锁后返回数据或者进入DB查询。
字符串的特性，我们直接锁缓存key，因为字符串也是共享的，会阻塞其他使用这个字符串的操作行为，
可以锁，常量+key


##  缓存雪崩
###  什么是缓存雪崩
当缓存服务器重启或者大量缓存集中在某一个时间段失效，这样在失效的时候，也会给后端系统(比如DB)带来很大压力


### 如何避免缓存雪崩
1. 缓存过期机制理论上能够将各个客户端的数据失效时间均匀地分布在时间轴上，（不同的key，设置不同的过期时间，让缓存失效的时间点尽量均匀）
1. 做二级缓存，A1为原始缓存，A2为拷贝缓存，A1失效时，可以访问A2，A1缓存失效时间设置为短期，A2设置为长期



