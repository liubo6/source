---
title: mysql行级锁
date: 2016-07-06 13:40:18
categories: 数据库
tags: mysql
---
行级锁是MySQL中粒度最小的一种锁，他能大大减少数据库操作的冲突,MYISAM引擎只支持表级锁，而 INNODB 引擎能够支持行级锁

INNODB 的行级锁有共享锁（S LOCK）和排他锁（X LOCK）两种。当数据对象被加上排它锁时，其他的事务不能对它读取和修改。加了共享锁的数据对象可以被其他事务读取，但不能修改。

<!--more-->

## 共享锁
```
用法： SELECT ... LOCK IN SHARE MODE;
```
MySQL会对查询结果集中每行都添加共享锁。锁申请前提：当前没有线程对该结果集中的任何行使用排他锁，否则申请会阻塞。
1. 使用共享锁线程可对其锁定记录进行读取，其他线程同样也可对锁定记录进行读取操作，并且这两个线程读取的数据都属于同一个版本。
2. 对于写入操作，使用共享锁的线程需要分情况讨论，当只有 当前线程对指定记录使用共享锁时，线程是可对该记录进行写入操作（包括更新与删除），这是由于在写入操作前，线程向该记录申请了排他锁，然后才进行写入操作； 当其他线程也对该记录使用共享锁时，则不可进行写入操作，系统会有报错提示。不对锁定记录使用共享锁的线程，当然是不可进行写入操作了，写入操作会阻塞。
3. 使用共享锁进程可再次对锁定记录申请共享锁，系统并不报错，但是操作本身并没有太大意义。其他线程同样也可以对锁定记录申请共享锁。
4. 使用共享锁进程可对其锁定记录申请排他锁；而其他进程是不可以对锁定记录申请排他锁，申请会阻塞。

## 排它锁
```
用法： SELECT ... FOR UPDATE;
```
MySQL会对查询结果集中每行都添加排他锁，**在事物操作中，任何对记录的更新与删除操作会自动加上排他锁**。 锁申请前提：当前没有线程对该结果集中的任何行使用排他锁或共享锁，否则申请会阻塞

1. 使用排他锁线程可对其锁定记录进行写入操作；对于不使用排他锁的线程，对锁定记录的写操作是不允许的，请求会阻塞。
2. 使用排他锁进程可对其锁定记录申请共享锁，但是申请共享锁之后，线程并不会释放原先的排他锁，因此该记录对外表现出排他锁的性质；其他线程是不可对已锁定记录申请共享锁，请求会阻塞。
3. 使用排他锁进程可对其锁定记录申请排他锁（实际上并没有任何意义）；而其他进程是不可对锁定记录申请排他锁，申请会阻塞。