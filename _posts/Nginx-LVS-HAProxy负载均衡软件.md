---
title: Nginx/LVS/HAProxy负载均衡软件
date: 2016-08-04 17:47:37
categories: 负载均衡
tags: 负载均衡
---
# 负载均衡

## 硬件
NetScaler、F5、Radware和Array等商用的负载均衡器

## 软件
LVS/HAProxy、Nginx的基于Linux的开源免费的负载均衡软件策略
<!--more-->
### LVS
```
1、抗负载能力强、是工作在网络4层之上仅作分发之用，没有流量的产生，这个特点也决定了它在负载均衡软件里的性能最强的；
 
2、配置性比较低，这是一个缺点也是一个优点，因为没有可太多配置的东西，所以并不需要太多接触，大大减少了人为出错的几率；
 
3、工作稳定，自身有完整的双机热备方案，如LVS+Keepalived和LVS+Heartbeat，不过我们在项目实施中用得最多的还是LVS/DR+Keepalived；
 
4、无流量，保证了均衡器IO的性能不会收到大流量的影响；
 
5、应用范围比较广，可以对所有应用做负载均衡；
 
6、软件本身不支持正则处理，不能做动静分离，这个就比较遗憾了；其实现在许多网站在这方面都有较强的需求，这个是Nginx/HAProxy+Keepalived的优势所在。
 
7、如果是网站应用比较庞大的话，实施LVS/DR+Keepalived起来就比较复杂了，特别后面有Windows Server应用的机器的话，如果实施及配置还有维护过程就比较复杂了，相对而言，Nginx/HAProxy+Keepalived就简单多了。

```

### Nginx
```
1、工作在网络的7层之上，可以针对http应用做一些分流的策略，比如针对域名、目录结构，它的正则规则比HAProxy更为强大和灵活，这也是许多朋友喜欢它的原因之一；
 
2、Nginx对网络的依赖非常小，理论上能ping通就就能进行负载功能，这个也是它的优势所在；
 
3、Nginx安装和配置比较简单，测试起来比较方便；
 
4、也可以承担高的负载压力且稳定，一般能支撑超过几万次的并发量；
 
5、Nginx可以通过端口检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点，不过其中缺点就是不支持url来检测；
 
6、Nginx仅能支持http和Email，这样就在适用范围上面小很多，这个它的弱势；
 
7、Nginx不仅仅是一款优秀的负载均衡器/反向代理软件，它同时也是功能强大的Web应用服务器。LNMP现在也是非常流行的web架构，大有和以前最流行的LAMP架构分庭抗争之势，在高流量的环境中也有很好的效果。
 
8、Nginx现在作为Web反向加速缓存越来越成熟了，很多朋友都已在生产环境下投入生产了，而且反映效果不错，速度比传统的Squid服务器更快，有兴趣的朋友可以考虑用其作为反向代理加速器。
```

### HAProxy
```
1、HAProxy是支持虚拟主机的，以前有朋友说这个不支持虚拟主机，我这里特此更正一下。
 
2、能够补充Nginx的一些缺点比如Session的保持，Cookie的引导等工作
 
3、支持url检测后端的服务器出问题的检测会有很好的帮助。
 
4、它跟LVS一样，本身仅仅就只是一款负载均衡软件；单纯从效率上来讲HAProxy更会比Nginx有更出色的负载均衡速度，在并发处理上也是优于Nginx的。
 
5、HAProxy可以对Mysql读进行负载均衡，对后端的MySQL节点进行检测和负载均衡，不过在后端的MySQL slaves数量超过10台时性能不如LVS，所以我向大家推荐LVS+Keepalived。
 
6、HAProxy的算法现在也越来越多了，具体有如下8种：
 
①roundrobin，表示简单的轮询，这个不多说，这个是负载均衡基本都具备的；
 
②static-rr，表示根据权重，建议关注；
 
③leastconn，表示最少连接者先处理，建议关注；
 
④source，表示根据请求源IP，这个跟Nginx的IP_hash机制类似，我们用其作为解决session问题的一种方法，建议关注；
 
⑤ri，表示根据请求的URI；
 
⑥rl_param，表示根据请求的URl参数'balance url_param' requires an URL parameter name；
 
⑦hdr(name)，表示根据HTTP请求头来锁定每一次HTTP请求；
 
⑧rdp-cookie(name)，表示根据据cookie(name)来锁定并哈希每一次TCP请求。
```

## 选择
### 第一阶段
利用Nginx或者HAProxy进行单点的负载均衡，这一阶段服务器规模刚脱离开单服务器、单数据库的模式，需要一定的负载均衡

### 第二阶段
随着网络服务进一步扩大，这时单点的Nginx已经不能满足，这时使用LVS或者商用F5就是首要选择，Nginx此时就作为LVS或者 F5的节点来使用，具体LVS或者F5的是选择是根据公司规模，人才以及资金能力来选择的

### 第三阶段
网络服务已经成为主流产品，此时随着公司知名度也进一步扩展，相关人才的能力以及数量也随之提升，这时无论从开发适合自身产品的定制，以及降低成本来讲开源的LVS，已经成为首选，这时LVS会成为主流

最终形成比较理想的状态为：F5/LVS<—>Haproxy<—>Squid/Varnish<—>AppServer

日PV小于1000万，用Nginx就完全可以
大型网站或重要的服务，且服务器比较多时，可以考虑用LVS
