---
title: 微服务实践
date: 2016-11-15 14:11:33
categories: 微服务
tags: 微服务
---
# 服务化架构的演进历史
![](http://ww2.sinaimg.cn/mw690/69045600gw1f9sq4fq8ssj20p605tq63.jpg)

1. MVC：解决前后端、界面、控制逻辑和业务逻辑分层问题 
2. RPC：远程过程调用，本质就是分布式协作和系统间的解耦 
3. SOA：服务化架构，企业级资产重用和异构系统间的集成对接 
4. 微服务化架构：敏捷交付、互联网、容器化发展的产物

<!--more-->
# 微服务
定义：微服务（MSA）是一种架构风格，旨在通过将功能分解到各个离散 的服务中以实现对解决方案的解耦。
![](http://ww3.sinaimg.cn/mw690/69045600gw1f9sq7uhc5yj20fs09cgq5.jpg)
## 特征
- 小
- 且只干一件事情
- 独立部署和生命周期管理
- 异构性
- 轻量级通信，RPC或者 Restful

## 微服务拆分原则
围绕业务功能进行垂直和水平拆分。大小粒度是难点，也是团队争论的焦点。

### 错误的实践
以代码量作为衡量标准，例如500 行以内
拆分的粒度越小越好

### 建议的原则
功能完整性、职责单一性 
粒度适中，团队可接受
迭代演进，非一蹴而就 
API的版本兼容性优先考虑

## 微服务开发原则
接口先行，语言中立，服务提供者和消费者解耦，并行开发，提升产能
### 错误的实践
服务提供者专注于内部实现，而不是优先提供契约化的接口 
担心接口变更，迟迟不提供接口契约，导致消费者无法并行开发
### 建议的原则
接口优先 
允许契约的变更，但项目组需就接口的兼容性做约束
契约驱动测试，实现服务提供者和消费者解耦
IDL，代码骨架自动生成

## 微服务测试原则
单元测试，契约测试（接口测试），行为测试，集成测试
微服务框架提供服务端和客户端Mock框架
![](http://ww2.sinaimg.cn/mw690/69045600gw1f9sqd1e69yj20q709jab4.jpg)

## 微服务部署原则
独立部署和生命周期管理、基础设施自动化
![](http://ww2.sinaimg.cn/mw690/69045600gw1f9sqe9ipabj20qj09a0ts.jpg)

## 微服务运行容器
Docker、PaaS平台(VM)
使用Docker部署微服务的优点总结： 
1.  一致的环境：线上线下环境一致 
2.  避免对特定云基础设施提供商的依赖 
3.  降低运维团队负担 
4.  高性能：接近裸机的性能 
5.  多租户
微服务云化： 
1.  云的弹性和敏捷 
2.  云的动态性和资源隔离 
3.  Dev&Ops

## 微服务治理原则
线上治理、实时动态生效
### 微服务治理策略
1.  流量控制：动态、静态流控 
2.  服务降级 
3.  超时控制 
4.  优先级调度 
5.  流量迁移 
6.  调用链跟踪和分析 
7.  服务路由 
8.  服务上线审批、下线通知 
9.  SLA策略控制...

### 服务路由,本地短路策略
![](http://ww4.sinaimg.cn/mw690/69045600gw1f9sqinyhb2j20jj0bgdgs.jpg)
1. 优先调用本JVM内部服务提供者、
1. 其次是相同主机或者VM的、
1. 最后是跨网络调用

## 服务调用方式：同步调用、异步调用、并行调用
![](http://ww4.sinaimg.cn/mw690/69045600gw1f9sqkjvk9cj20q80bkwk5.jpg)

## 微服务故障隔离：线程级、进程级、容器级、VM级、物理机...
![](http://ww3.sinaimg.cn/mw690/69045600gw1f9sqkkoj79j20pt0bkjuu.jpg)

## 事务一致性：大部分是最终一致性、极少部分需要强一致性
![](http://ww2.sinaimg.cn/mw690/69045600gw1f9sqkktnxij20pq0apwi7.jpg)

## 时延问题：非阻塞I/O、二进制、长链接、码流压缩
![](http://ww2.sinaimg.cn/mw690/69045600gw1f9sqn1epbtj20ob0bw0u7.jpg)

## 微服务接口兼容性：技术保障、管理协同
1. 制定并严格执行《微服务前向兼容性规范》，避免发生不兼容修改或者私自修改不通知周边的情况 
2. 接口兼容性技术保障：例如Thrift的IDL，支持新增、修改和删除字段，字段定义位置无关性，码流支持乱序等 
3. 持续交付流水线的每日构建和契约化驱动测试，能够快速识别和发现不兼容


